<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="关于Python元类metaclass和在ORM中的应用"><meta name="keywords" content="Python"><meta name="author" content="Ykk,undefined"><meta name="copyright" content="Ykk"><title>关于Python元类metaclass和在ORM中的应用 | Ykk</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://jjeejj.github.io/css/gitment.css"><script src="https://jjeejj.github.io/js/gitment.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#type和metaclass生成类"><span class="toc-number">1.</span> <span class="toc-text">type和metaclass生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#type生成类"><span class="toc-number">1.1.</span> <span class="toc-text">type生成类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metaclass生成类"><span class="toc-number">1.2.</span> <span class="toc-text">metaclass生成类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ORM实例"><span class="toc-number">2.</span> <span class="toc-text">ORM实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#廖雪峰简单ORM"><span class="toc-number">2.1.</span> <span class="toc-text">廖雪峰简单ORM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更复杂的一个ORM"><span class="toc-number">2.2.</span> <span class="toc-text">更复杂的一个ORM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#知识点学习"><span class="toc-number">3.</span> <span class="toc-text">知识点学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#asyncio异步IO库"><span class="toc-number">3.1.</span> <span class="toc-text">asyncio异步IO库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logging日志库"><span class="toc-number">3.2.</span> <span class="toc-text">logging日志库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yield和yield-from"><span class="toc-number">3.3.</span> <span class="toc-text">yield和yield from</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#三个概念："><span class="toc-number">3.3.1.</span> <span class="toc-text">三个概念：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yield-from"><span class="toc-number">3.3.2.</span> <span class="toc-text">yield from</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关于协程Coroutine"><span class="toc-number">3.3.3.</span> <span class="toc-text">关于协程Coroutine</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://blog-1252404748.cos.ap-chengdu.myqcloud.com/avatar.jpg"></div><div class="author-info__name text-center">Ykk</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/cloisonne" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">54</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">43</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">12</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-1252404748.cos.ap-chengdu.myqcloud.com/bg-1.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Ykk</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/resume">Resume</a></span></div><div id="post-info"><div id="post-title">关于Python元类metaclass和在ORM中的应用</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-01-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Codes/">Codes</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3,532</span><span class="post-meta__separator">|</span><span>Reading time: 16 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>元类其实并不复杂，即生成类的一个类，type可以动态创建类，同时，可以使用更为强大的metaclass。<br>ORM是这种模式的应用场景，即Object Relational Mapping。此外本文还介绍了协程coroutine和logging模块。</p>
<a id="more"></a>
<hr>
<h2 id="type和metaclass生成类"><a href="#type和metaclass生成类" class="headerlink" title="type和metaclass生成类"></a>type和metaclass生成类</h2><h3 id="type生成类"><a href="#type生成类" class="headerlink" title="type生成类"></a>type生成类</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fn</span><span class="params">(self, name=<span class="string">'world'</span>)</span>:</span> <span class="comment"># 先定义函数</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s.'</span> % name)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Hello = type(<span class="string">'Hello'</span>, (object,), dict(hello=fn)) <span class="comment"># 创建Hello class</span></span><br></pre></td></tr></table></figure>
<h3 id="metaclass生成类"><a href="#metaclass生成类" class="headerlink" title="metaclass生成类"></a>metaclass生成类</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        attrs[<span class="string">'add'</span>] = <span class="keyword">lambda</span> self, value: self.append(value)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span><span class="params">(list, metaclass=ListMetaclass)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ORM实例"><a href="#ORM实例" class="headerlink" title="ORM实例"></a>ORM实例</h2><h3 id="廖雪峰简单ORM"><a href="#廖雪峰简单ORM" class="headerlink" title="廖雪峰简单ORM"></a>廖雪峰简单ORM</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用metaclass写一个ORM的demo</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, column_type)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.column_type = column_type</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回对象的字符串表达式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;%s:%s&gt;'</span> % (self.__class__.name, self.name)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        super(StringField, self).__init__(name,<span class="string">'varchar(100)'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntagerField</span><span class="params">(Field)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        super(IntagerField, self).__init__(name, <span class="string">'bigint'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'Model'</span>:</span><br><span class="line">            <span class="keyword">return</span> type.__new__(cls,name,bases,attrs)</span><br><span class="line">        print(<span class="string">'Found model: %s'</span> % name)</span><br><span class="line">        mappings = dict()</span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(v, Field):</span><br><span class="line">                print(<span class="string">'Found mapping: %s ==&gt; %s'</span> % (k,v))</span><br><span class="line">                mappings[k] = v</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</span><br><span class="line">            attrs.pop()</span><br><span class="line">        attrs[<span class="string">'__mappings__'</span>] = mappings</span><br><span class="line">        attrs[<span class="string">'__table__'</span>] = name</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaclass)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kw)</span>:</span></span><br><span class="line">        super(Model, self).__init__(**kw)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self[key]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">r"'Model' object has no attribute '%s'"</span> % key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></span><br><span class="line">        fields = []</span><br><span class="line">        params = []</span><br><span class="line">        args = []</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> self.__mappings__.items():</span><br><span class="line">            fields.append(v.name)</span><br><span class="line">            params.append(<span class="string">'?'</span>)</span><br><span class="line">            args.append(getattr(self, k, <span class="keyword">None</span>))</span><br><span class="line">        sql = <span class="string">'insert into %s (%s) values (%s)'</span> % (self.__table__, <span class="string">','</span>.join(fields), <span class="string">','</span>.join(params))</span><br><span class="line">        print(<span class="string">'SQL: %s'</span> % sql)</span><br><span class="line">        print(<span class="string">'ARGS: %s'</span> % str(args))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用方法</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Model)</span>:</span></span><br><span class="line">    id = IntagerField(<span class="string">'id'</span>)</span><br><span class="line">    name = StringField(<span class="string">'username'</span>)</span><br><span class="line">    email = StringField(<span class="string">'email'</span>)</span><br><span class="line">    password = StringField(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">u = User(id = <span class="number">12345</span>, name = <span class="string">'Li'</span>, email = <span class="string">'123'</span>, password = <span class="string">'22'</span>)</span><br><span class="line"></span><br><span class="line">u.save()</span><br></pre></td></tr></table></figure>
<h3 id="更复杂的一个ORM"><a href="#更复杂的一个ORM" class="headerlink" title="更复杂的一个ORM"></a>更复杂的一个ORM</h3><p>来自<a href="http://www.songluyi.com/python-%e7%bc%96%e5%86%99orm%e6%97%b6%e7%9a%84%e9%87%8d%e9%9a%be%e7%82%b9%e6%8e%8c%e6%8f%a1/" target="_blank" rel="noopener">编写orm时的重难点掌握</a></p>
<p>代码比较复杂：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="comment"># 一次使用异步 处处使用异步</span></span><br><span class="line"><span class="keyword">import</span> aiomysql</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(sql,args=<span class="params">()</span>)</span>:</span></span><br><span class="line">    logging.info(<span class="string">'SQL:%s'</span> %sql)</span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_pool</span><span class="params">(loop, **kw)</span>:</span></span><br><span class="line">    logging.info(<span class="string">' start creating database connection pool'</span>)</span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    <span class="comment"># 理解这里的yield from 是很重要的</span></span><br><span class="line">    __pool=<span class="keyword">yield</span> <span class="keyword">from</span> aiomysql.create_pool(</span><br><span class="line">        host=kw.get(<span class="string">'host'</span>,<span class="string">'localhost'</span>),</span><br><span class="line">        port=kw.get(<span class="string">'port'</span>,<span class="number">3306</span>),</span><br><span class="line">        user=kw[<span class="string">'user'</span>],</span><br><span class="line">        password=kw[<span class="string">'password'</span>],</span><br><span class="line">        db=kw[<span class="string">'db'</span>],</span><br><span class="line">        charset=kw.get(<span class="string">'charset'</span>,<span class="string">'utf8'</span>),</span><br><span class="line">        autocommit=kw.get(<span class="string">'autocommit'</span>,<span class="keyword">True</span>),</span><br><span class="line">        maxsize=kw.get(<span class="string">'maxsize'</span>,<span class="number">10</span>),</span><br><span class="line">        <span class="comment"># 目前不清楚这个minsize是什么鬼</span></span><br><span class="line">        minsize=kw.get(<span class="string">'minsize'</span>,<span class="number">1</span>),</span><br><span class="line">        loop=loop</span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy_pool</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    <span class="keyword">if</span> __pool <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> :</span><br><span class="line">        __pool.close()</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> __pool.wait_closed()</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 我很好奇为啥不用commit 事务不用提交么</span></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(sql, args, size=None)</span>:</span></span><br><span class="line">    log(sql,args)</span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    <span class="comment"># 666 建立游标</span></span><br><span class="line">    <span class="comment"># -*- yield from 将会调用一个子协程，并直接返回调用的结果</span></span><br><span class="line">    <span class="comment"># yield from从连接池中返回一个连接</span></span><br><span class="line">    <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> __pool)<span class="keyword">as</span> conn:</span><br><span class="line">        cur = <span class="keyword">yield</span> <span class="keyword">from</span> conn.cursor(aiomysql.DictCursor)</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> cur.execute(sql.replace(<span class="string">'?'</span>, <span class="string">'%s'</span>), args)</span><br><span class="line">        <span class="keyword">if</span> size:</span><br><span class="line">            rs = <span class="keyword">yield</span> <span class="keyword">from</span> cur.fetchmany(size)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rs = <span class="keyword">yield</span> <span class="keyword">from</span> cur.fetchall()</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> cur.close()</span><br><span class="line">        logging.info(<span class="string">'rows have returned %s'</span> %len(rs))</span><br><span class="line">    <span class="keyword">return</span> rs</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 封装INSERT, UPDATE, DELETE</span></span><br><span class="line"><span class="comment"># 语句操作参数一样，所以定义一个通用的执行函数</span></span><br><span class="line"><span class="comment"># 返回操作影响的行号</span></span><br><span class="line"><span class="comment"># 我想说的是 知道影响行号有个叼用</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(sql,args, autocommit=True)</span>:</span></span><br><span class="line">    log(sql)</span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> __pool) <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 因为execute类型sql操作返回结果只有行号，不需要dict</span></span><br><span class="line">            cur = <span class="keyword">yield</span> <span class="keyword">from</span> conn.cursor()</span><br><span class="line">            <span class="comment"># 顺便说一下 后面的args 别掉了 掉了是无论如何都插入不了数据的</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> cur.execute(sql.replace(<span class="string">'?'</span>, <span class="string">'%s'</span>), args)</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> conn.commit()</span><br><span class="line">            affected_line=cur.rowcount</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> cur.close()</span><br><span class="line">            print(<span class="string">'execute : '</span>, affected_line)</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> affected_line</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 这个函数主要是把查询字段计数 替换成sql识别的?</span></span><br><span class="line"><span class="comment"># 比如说：insert into  `User` (`password`, `email`, `name`, `id`) values (?,?,?,?)  看到了么 后面这四个问号</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_args_string</span><span class="params">(num)</span>:</span></span><br><span class="line">    lol=[]</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(num):</span><br><span class="line">        lol.append(<span class="string">'?'</span>)</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">','</span>.join(lol))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义Field类，负责保存(数据库)表的字段名和字段类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 表的字段包含名字、类型、是否为表的主键和默认值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, column_type, primary__key, default)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.column_type=column_type</span><br><span class="line">        self.primary_key=primary__key</span><br><span class="line">        self.default=default</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 返回 表名字 字段名 和字段类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&amp;lt;%s , %s , %s&amp;gt;"</span> %(self.__class__.__name__, self.name, self.column_type)</span><br><span class="line"><span class="comment"># 定义数据库中五个存储类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, primary_key=False, default=None, ddl=<span class="string">'varchar(100)'</span>)</span>:</span></span><br><span class="line">        super().__init__(name,ddl,primary_key,default)</span><br><span class="line"><span class="comment"># 布尔类型不可以作为主键</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooleanField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, default=None)</span>:</span></span><br><span class="line">        super().__init__(name,<span class="string">'Boolean'</span>,<span class="keyword">False</span>, default)</span><br><span class="line"><span class="comment"># 不知道这个column type是否可以自己定义 先自己定义看一下</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntegerField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, primary_key=False, default=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__(name, <span class="string">'int'</span>, primary_key, default)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FloatField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, primary_key=False,default=<span class="number">0.0</span>)</span>:</span></span><br><span class="line">        super().__init__(name, <span class="string">'float'</span>, primary_key, default)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, default=None)</span>:</span></span><br><span class="line">        super().__init__(name,<span class="string">'text'</span>,<span class="keyword">False</span>, default)</span><br><span class="line"><span class="comment"># class Model(dict,metaclass=ModelMetaclass):</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># -*-定义Model的元类</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 所有的元类都继承自type</span></span><br><span class="line"><span class="comment"># ModelMetaclass元类定义了所有Model基类(继承ModelMetaclass)的子类实现的操作</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># -*-ModelMetaclass的工作主要是为一个数据库表映射成一个封装的类做准备：</span></span><br><span class="line"><span class="comment"># ***读取具体子类(user)的映射信息</span></span><br><span class="line"><span class="comment"># 创造类的时候，排除对Model类的修改</span></span><br><span class="line"><span class="comment"># 在当前类中查找所有的类属性(attrs)，如果找到Field属性，就将其保存到__mappings__的dict中，同时从类属性中删除Field(防止实例属性遮住类的同名属性)</span></span><br><span class="line"><span class="comment"># 将数据库表名保存到__table__中</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 完成这些工作就可以在Model中定义各种数据库的操作方法</span></span><br><span class="line"><span class="comment"># metaclass是类的模板，所以必须从`type`类型派生：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="comment"># __new__控制__init__的执行，所以在其执行之前</span></span><br><span class="line">    <span class="comment"># cls:代表要__init__的类，此参数在实例化时由Python解释器自动提供(例如下文的User和Model)</span></span><br><span class="line">    <span class="comment"># bases：代表继承父类的集合</span></span><br><span class="line">    <span class="comment"># attrs：类的方法集合</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        <span class="comment"># 排除model 是因为要排除对model类的修改</span></span><br><span class="line">        <span class="keyword">if</span> name==<span class="string">'Model'</span>:</span><br><span class="line">            <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line">        <span class="comment"># 获取table名称 为啥获取table名称 至于在哪里我也是不明白握草</span></span><br><span class="line">        table_name=attrs.get(<span class="string">'__table__'</span>, <span class="keyword">None</span>) <span class="keyword">or</span> name</span><br><span class="line">        logging.info(<span class="string">'found table: %s (table: %s) '</span> %(name,table_name ))</span><br><span class="line">        <span class="comment"># 获取Field所有主键名和Field</span></span><br><span class="line">        mappings=dict()</span><br><span class="line">        fields=[]</span><br><span class="line">        primaryKey=<span class="keyword">None</span></span><br><span class="line">        <span class="comment"># 这个k是表示字段名</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(v, Field):</span><br><span class="line">                logging.info(<span class="string">'Found mapping %s===&amp;gt;%s'</span> %(k, v))</span><br><span class="line">            <span class="comment"># 注意mapping的用法</span></span><br><span class="line">                mappings[k] = v</span><br><span class="line">                <span class="keyword">if</span> v.primary_key:</span><br><span class="line">                    logging.info(<span class="string">'fond primary key hahaha %s'</span>%k)</span><br><span class="line">                    <span class="comment"># 这里很有意思 当第一次主键存在primaryKey被赋值 后来如果再出现主键的话就会引发错误</span></span><br><span class="line">                    <span class="keyword">if</span> primaryKey:</span><br><span class="line">                        <span class="keyword">raise</span> RuntimeError(<span class="string">'Duplicated key for field'</span>)</span><br><span class="line">                    primaryKey=k</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    fields.append(k)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> primaryKey:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Primary key not found!'</span>)</span><br><span class="line">        <span class="comment"># w下面位字段从类属性中删除Field 属性</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</span><br><span class="line">            attrs.pop(k)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 保存除主键外的属性为''列表形式</span></span><br><span class="line">        <span class="comment"># 这一句的lambda表达式没懂</span></span><br><span class="line">        escaped_fields=list(map(<span class="keyword">lambda</span> f:<span class="string">'`%s`'</span> %f, fields))</span><br><span class="line">        <span class="comment"># 保存属性和列的映射关系</span></span><br><span class="line">        attrs[<span class="string">'__mappings__'</span>]=mappings</span><br><span class="line">        <span class="comment"># 保存表名</span></span><br><span class="line">        attrs[<span class="string">'__table__'</span>]=table_name</span><br><span class="line">        <span class="comment"># 保存主键名称</span></span><br><span class="line">        attrs[<span class="string">'__primary_key__'</span>]=primaryKey</span><br><span class="line">        <span class="comment"># 保存主键外的属性名</span></span><br><span class="line">        attrs[<span class="string">'__fields__'</span>]=fields</span><br><span class="line">        <span class="comment"># 构造默认的增删改查 语句</span></span><br><span class="line">        attrs[<span class="string">'__select__'</span>]=<span class="string">'select `%s`, %s from `%s` '</span>%(primaryKey,<span class="string">', '</span>.join(escaped_fields), table_name)</span><br><span class="line">        attrs[<span class="string">'__insert__'</span>] = <span class="string">'insert into  `%s` (%s, `%s`) values (%s) '</span> %(table_name, <span class="string">', '</span>.join(escaped_fields), primaryKey, create_args_string(len(escaped_fields)+<span class="number">1</span>))</span><br><span class="line">        attrs[<span class="string">'__update__'</span>]=<span class="string">'update `%s` set %s where `%s` = ?'</span> %(table_name, <span class="string">', '</span>.join(map(<span class="keyword">lambda</span> f:<span class="string">'`%s`=?'</span> % (mappings.get(f).name <span class="keyword">or</span> f), fields)), primaryKey)</span><br><span class="line">        attrs[<span class="string">'__delete__'</span>]=<span class="string">'delete `%s` where `%s`=?'</span> %(table_name, primaryKey)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义ORM所有映射的基类：Model</span></span><br><span class="line"><span class="comment"># Model类的任意子类可以映射一个数据库表</span></span><br><span class="line"><span class="comment"># Model类可以看作是对所有数据库表操作的基本定义的映射</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 基于字典查询形式</span></span><br><span class="line"><span class="comment"># Model从dict继承，拥有字典的所有功能，同时实现特殊方法__getattr__和__setattr__，能够实现属性操作</span></span><br><span class="line"><span class="comment"># 实现数据库操作的所有方法，定义为class方法，所有继承自Model都具有数据库操作方法</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict,metaclass=ModelMetaclass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kw)</span>:</span></span><br><span class="line">        super(Model,self).__init__(**kw)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self[key]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">"'Model' object have no attribution: %s"</span>% key)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key] =value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getValue</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="comment"># 这个是默认内置函数实现的</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self, key, <span class="keyword">None</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getValueOrDefault</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        value=getattr(self, key , <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            field = self.__mappings__[key]</span><br><span class="line">            <span class="keyword">if</span> field.default <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                value = field.default() <span class="keyword">if</span> callable(field.default) <span class="keyword">else</span> field.default</span><br><span class="line">                logging.info(<span class="string">'using default value for %s : %s '</span> % (key, str(value)))</span><br><span class="line">                setattr(self, key, value)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="comment"># 类方法有类变量cls传入，从而可以用cls做一些相关的处理。并且有子类继承时，调用该类方法时，传入的类变量cls是子类，而非父类。</span></span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_all</span><span class="params">(cls, where=None, args=None, **kw)</span>:</span></span><br><span class="line">        sql = [cls.__select__]</span><br><span class="line">        <span class="keyword">if</span> where:</span><br><span class="line">            sql.append(<span class="string">'where'</span>)</span><br><span class="line">            sql.append(where)</span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            args = []</span><br><span class="line"> </span><br><span class="line">        orderBy = kw.get(<span class="string">'orderBy'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> orderBy:</span><br><span class="line">            sql.append(<span class="string">'order by'</span>)</span><br><span class="line">            sql.append(orderBy)</span><br><span class="line">        <span class="comment"># dict 提供get方法 指定放不存在时候返回后学的东西 比如a.get('Fuck',None)</span></span><br><span class="line">        limit = kw.get(<span class="string">'limit'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> limit <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            sql.append(<span class="string">'limit'</span>)</span><br><span class="line">            <span class="keyword">if</span> isinstance(limit, int):</span><br><span class="line">                sql.append(<span class="string">'?'</span>)</span><br><span class="line">                args.append(limit)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(limit, tuple) <span class="keyword">and</span> len(limit) ==<span class="number">2</span>:</span><br><span class="line">                sql.append(<span class="string">'?,?'</span>)</span><br><span class="line">                args.extend(limit)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Invalid limit value : %s '</span>%str(limit))</span><br><span class="line"> </span><br><span class="line">        rs = <span class="keyword">yield</span> <span class="keyword">from</span> select(<span class="string">' '</span>.join(sql),args)</span><br><span class="line">        <span class="keyword">return</span> [cls(**r) <span class="keyword">for</span> r <span class="keyword">in</span> rs]</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findNumber</span><span class="params">(cls, selectField, where=None, args=None)</span>:</span></span><br><span class="line">        <span class="string">'''find number by select and where.'''</span></span><br><span class="line">        sql = [<span class="string">'select %s __num__ from `%s`'</span> %(selectField, cls.__table__)]</span><br><span class="line">        <span class="keyword">if</span> where:</span><br><span class="line">            sql.append(<span class="string">'where'</span>)</span><br><span class="line">            sql.append(where)</span><br><span class="line">        rs = <span class="keyword">yield</span> <span class="keyword">from</span> select(<span class="string">' '</span>.join(sql), args, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> len(rs) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> rs[<span class="number">0</span>][<span class="string">'__num__'</span>]</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 这个黑魔法我还在研究呢~</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(cls, primarykey)</span>:</span></span><br><span class="line">        <span class="string">'''find object by primary key'''</span></span><br><span class="line">        rs = <span class="keyword">yield</span> <span class="keyword">from</span> select(<span class="string">'%s where `%s`=?'</span> %(cls.__select__, cls.__primary_key__), [primarykey], <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> len(rs) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> cls(**rs[<span class="number">0</span>])</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findAll</span><span class="params">(cls, **kw)</span>:</span></span><br><span class="line">        rs = []</span><br><span class="line">        <span class="keyword">if</span> len(kw) == <span class="number">0</span>:</span><br><span class="line">            rs = <span class="keyword">yield</span> <span class="keyword">from</span> select(cls.__select__, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            args=[]</span><br><span class="line">            values=[]</span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> kw.items():</span><br><span class="line">                args.append(<span class="string">'%s=?'</span> % k )</span><br><span class="line">                values.append(v)</span><br><span class="line">            rs = <span class="keyword">yield</span> <span class="keyword">from</span> select(<span class="string">'%s where %s '</span> % (cls.__select__,  <span class="string">' and '</span>.join(args)), values)</span><br><span class="line">        <span class="keyword">return</span> rs</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = list(map(self.getValueOrDefault, self.__fields__))</span><br><span class="line">        print(<span class="string">'save:%s'</span> % args)</span><br><span class="line">        args.append(self.getValueOrDefault(self.__primary_key__))</span><br><span class="line">        rows = <span class="keyword">yield</span> <span class="keyword">from</span> execute(self.__insert__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            print(self.__insert__)</span><br><span class="line">            logging.warning(<span class="string">'failed to insert record: affected rows: %s'</span> %rows)</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="comment"># 显示方言错误是什么鬼。。。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = list(map(self.getValue, self.__fields__))</span><br><span class="line">        args.append(self.getValue(self.__primary_key__))</span><br><span class="line">        rows = <span class="keyword">yield</span> <span class="keyword">from</span> execute(self.__update__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            logging.warning(<span class="string">'failed to update record: affected rows: %s'</span>%rows)</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = [self.getValue(self.__primary_key__)]</span><br><span class="line">        rows = <span class="keyword">yield</span> <span class="keyword">from</span> execute(self.__updata__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            logging.warning(<span class="string">'failed to remove by primary key: affected rows: %s'</span> %rows)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Model)</span>:</span></span><br><span class="line">        id = IntegerField(<span class="string">'id'</span>,primary_key=<span class="keyword">True</span>)</span><br><span class="line">        name = StringField(<span class="string">'username'</span>)</span><br><span class="line">        email = StringField(<span class="string">'email'</span>)</span><br><span class="line">        password = StringField(<span class="string">'password'</span>)</span><br><span class="line">    <span class="comment">#创建异步事件的句柄</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#创建实例</span></span><br><span class="line"><span class="meta">    @asyncio.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> create_pool(loop=loop,host=<span class="string">'localhost'</span>, port=<span class="number">3308</span>, user=<span class="string">'sly'</span>, password=<span class="string">'070801382'</span>, db=<span class="string">'test'</span>)</span><br><span class="line">        user = User(id=<span class="number">8</span>, name=<span class="string">'sly'</span>, email=<span class="string">'slysly759@gmail.com'</span>, password=<span class="string">'fuckblog'</span>)</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> user.save()</span><br><span class="line">        r = <span class="keyword">yield</span> <span class="keyword">from</span> User.find(<span class="string">'11'</span>)</span><br><span class="line">        print(r)</span><br><span class="line">        r = <span class="keyword">yield</span> <span class="keyword">from</span> User.findAll()</span><br><span class="line">        print(<span class="number">1</span>, r)</span><br><span class="line">        r = <span class="keyword">yield</span> <span class="keyword">from</span> User.findAll(id=<span class="string">'12'</span>)</span><br><span class="line">        print(<span class="number">2</span>, r)</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> destroy_pool()</span><br><span class="line"> </span><br><span class="line">    loop.run_until_complete(test())</span><br><span class="line">    loop.close()</span><br><span class="line">    <span class="keyword">if</span> loop.is_closed():</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="知识点学习"><a href="#知识点学习" class="headerlink" title="知识点学习"></a>知识点学习</h2><h3 id="asyncio异步IO库"><a href="#asyncio异步IO库" class="headerlink" title="asyncio异步IO库"></a>asyncio异步IO库</h3><p>廖雪峰中的asyncio异步获取网页例子：</p>
<p>注意异步操作需要在<code>coroutine</code>中通过<code>yield from</code>完成</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wget</span><span class="params">(host)</span>:</span></span><br><span class="line">    print(<span class="string">'wget %s...'</span> % host)</span><br><span class="line">    connect = asyncio.open_connection(host, <span class="number">80</span>)</span><br><span class="line">    reader, writer = <span class="keyword">yield</span> <span class="keyword">from</span> connect</span><br><span class="line">    header = <span class="string">'GET / HTTP/1.0\r\nHost: %s\r\n\r\n'</span> % host</span><br><span class="line">    writer.write(header.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        line = <span class="keyword">yield</span> <span class="keyword">from</span> reader.readline()</span><br><span class="line">        <span class="keyword">if</span> line == <span class="string">b'\r\n'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">'%s header &gt; %s'</span> % (host, line.decode(<span class="string">'utf-8'</span>).rstrip()))</span><br><span class="line">    <span class="comment"># Ignore the body, close the socket</span></span><br><span class="line">    writer.close()</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [wget(host) <span class="keyword">for</span> host <span class="keyword">in</span> [<span class="string">'www.sina.com.cn'</span>, <span class="string">'www.sohu.com'</span>, <span class="string">'www.163.com'</span>]]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>
<h3 id="logging日志库"><a href="#logging日志库" class="headerlink" title="logging日志库"></a>logging日志库</h3><p>知乎上有个问题里拿来的demo:</p>
<p>问题是为什么pycharm的traceback还有ERROR等打印顺序会发生变化，加了sleep就不会变化了。</p>
<p>我猜测是pycharm有一些异步执行的步骤，具体也没有在StackOverflow上找到答案。<code>作为TODO吧</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'try'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    r = <span class="number">10</span> / int(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'result'</span>, r)</span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    logging.exception(e)</span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'exception'</span>, e)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'no error'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'finally.'</span>)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'END**************'</span>)</span><br></pre></td></tr></table></figure>
<p>logging的级别：</p>
<ul>
<li>DEBUG</li>
<li>INFO</li>
<li>WARNING</li>
<li>ERROR</li>
<li>CRITICAL</li>
<li>NOSET</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">logger.debug(<span class="string">'debug message'</span>)</span><br><span class="line">logger.info(<span class="string">'info message'</span>)</span><br><span class="line">logger.warn(<span class="string">'warn message'</span>)</span><br><span class="line">logger.error(<span class="string">'error message'</span>)</span><br><span class="line">logger.critical(<span class="string">'critical message'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="yield和yield-from"><a href="#yield和yield-from" class="headerlink" title="yield和yield from"></a>yield和yield from</h3><h4 id="三个概念："><a href="#三个概念：" class="headerlink" title="三个概念："></a>三个概念：</h4><ul>
<li>生成器<br>  一边循环一边计算的机制，称为生成器：generator</li>
<li>可迭代<br>  可迭代是指一种可以在容器中逐个提取元素的能力。<br>  必须具备<code>__iter__()</code></li>
<li>迭代器<br>  <code>__iter__()</code><br>  <code>__next__()</code></li>
</ul>
<p>yield写斐波那契</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fab_yield</span><span class="params">(max)</span>:</span></span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n&lt;max:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        <span class="comment"># print b</span></span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">f=fab_yield(<span class="number">100</span>)</span><br><span class="line">print(type(f))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>
<h4 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h4><blockquote>
<p>总之大意是原本的yield语句只能将CPU控制权还给直接调用者，当你想要将一个generator或者coroutine里带有yield语句的逻辑重构到另一个generator（原文是subgenerator）里的时候，会非常麻烦，因为外面的generator要负责为里面的generator做消息传递；所以某人有个想法是让python把消息传递封装起来，使其对程序猿透明，于是就有了yield from。</p>
</blockquote>
<p>假设A函数中有这样一个语句</p>
<blockquote>
<p>yield from B()</p>
</blockquote>
<p>B()返回的是一个可迭代（iterable）的对象b，那么A()会返回一个 generator——照我们的命名规范，名字叫a——那么：</p>
<ol>
<li>b迭代产生的每个值都直接传递给a的调用者。</li>
<li>所有通过<code>send</code>方法发送到a的值都被直接传递给b. 如果发送的值是<code>None</code>，则调用b的<code>__next__()</code>方法，否则调用b的<code>send</code>方法。如果对b的方法调用产生<code>StopIteration</code>异常，a会继续执行<code>yield from</code>后面的语句，而其他异常则会传播到a中，导致a在执行<code>yield from</code>的时候抛出异常。</li>
<li>如果有除<code>GeneratorExit</code>以外的异常被throw到a中的话，该异常会被直接throw到b中。如果b的<code>throw</code>方法抛出<code>StopIteration</code>， a会继续执行；其他异常则会导致a也抛出异常。</li>
<li>如果一个<code>GeneratorExit</code>异常被throw到a中，或者a的<code>close</code>方法被调用了，并且b也有<code>close</code>方法的话，b的<code>close</code>方法也会被调用。如果b的这个方法抛出了异常，则会导致a也抛出异常。 反之，如果b成功close掉了，a也会抛出异常，但是是特定的<code>GeneratorExit</code>异常。</li>
<li>a中<code>yield fro</code>m表达式的求值结果是b迭代结束时抛出的<code>StopIteration</code>异常的第一个参数。</li>
<li>b中的<code>return &lt;expr&gt;</code>语句实际上会抛出<code>StopIteration(&lt;expr&gt;)</code> 异常，所以b中return的值会成为a中<code>yield from</code>表达式的返回值。</li>
</ol>
<h4 id="关于协程Coroutine"><a href="#关于协程Coroutine" class="headerlink" title="关于协程Coroutine"></a>关于协程Coroutine</h4><ul>
<li>不是线程切换，而是由程序自身控制，因此，没有线程切换的开销</li>
<li>不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</li>
</ul>
<hr>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Ykk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ykksmile.top/posts/29034/">https://ykksmile.top/posts/29034/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="social-share" data-disabled="google,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/posts/61970/"><i class="fa fa-chevron-left">  </i><span>google机器学习速成课程总结</span></a></div><div class="next-post pull-right"><a href="/posts/42320/"><span>SIM模块的串口通信例程</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  owner: 'cloisonne',
  repo: 'cloisonne.github.io',
  oauth: {
    client_id: 'd6cdb36f97d08963e9cc',
    client_secret: '32f854846bf95d283ee654337570bbed41f69f03'
  }
})
gitment.render('gitment-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2016 - 2018 By Ykk</div><div class="framework-info"><span>Driven By   </span><a href="https://pages.coding.me"><span>Coding Pages </span></a><!--span.footer-separator |--><!--i(class='fa fa-heart animated infinite pulse')--><!--span= _p('footer.theme') + ' - '--><span> &amp; </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="icp"><a><span>陕ICP备18010505号</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>